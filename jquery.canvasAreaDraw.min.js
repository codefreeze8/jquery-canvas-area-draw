!function(t){t.widget("custom.htmlimagemap",{options:{name:"map",image:null,mobile:!1,imageUrl:"",label:"",labelFont:"14px Arial",labelColor:"#ffffff",activeColor:"255,20,20",inactiveColor:"#323232",fillOpacity:"0.3",lineWidth:2,handleColor:"#cccccc",mode:"",areas:[{href:"",coords:[]}],onMove:function(t){},onUpdateArea:function(t){},onSelect:function(t){}},_applyHandler:function(t){var s=this.isCSMode()?this._CSMode:this,e=s[t];"function"==typeof e&&e.apply(s,[].slice.call(arguments,1))},_create:function(){var s,e=this;this.__activeArea=0,this.__activeCoord=void 0,this.__settings=void 0,this.__$canvas=void 0,this.__ctx=void 0,this.__image=this.options.image?t(this.options.image)[0]:new Image,this.__boundaryArea=[0,0,0,0],this.__$canvas=this._initCanvas(),this.__ctx=this.__$canvas[0].getContext("2d"),t(this.element).append(this.__$canvas),t(this.__$canvas).on("mousedown",function(t){e._applyHandler("__mousedown",t)}),t(this.__$canvas).on("contextmenu",function(t){e._applyHandler("__rightclick",t)}),t(this.__$canvas).on("mouseup",function(t){e._applyHandler("__mouseup",t)}),t(this.__$canvas).on("mouseleave",function(t){e.__stopdrag(t)}),this.options.mobile&&o(this.__$canvas[0]),this.isCSMode()&&(this._CSMode.init(this),s=this._CSMode.onCanvasSizeUpdate.bind(this._CSMode)),this.setImageUrl(this.options.imageUrl,s)},_initCanvas:function(){var s=t("<canvas>");return s[0].getContext||"undefined"==typeof G_vmlCanvasManager||(s[0]=G_vmlCanvasManager.initElement(s[0])),s},_clearCtx:function(t){t.clearRect(0,0,t.canvas.width,t.canvas.height)},__redraw:function(){t(this.__$canvas[0]).attr("height",this.__image.height).attr("width",this.__image.width),t(this.__$canvas[0]).css("height",this.__image.height+"px").css("width",this.__image.width+"px"),this.__$canvas[0].width=this.__image.width,this.__$canvas[0].height=this.__image.height,this.__draw()},__move:function(s){s.offsetX=s.pageX-t(this.__$canvas[0]).offset().left,s.offsetY=s.pageY-t(this.__$canvas[0]).offset().top,t.browser.msie&&parseFloat(t.browser.version)<8&&(s.offsetY=s.offsetY-t("body").scrollTop()),this.options.areas[this.__activeArea].coords[this.__activeCoord]=Math.round(s.offsetX),this.options.areas[this.__activeArea].coords[this.__activeCoord+1]=Math.round(s.offsetY),this.__redraw(),this.options.onMove(this.options.areas[this.__activeArea])},__stopdrag:function(){t(this.element).off("mousemove");var e=this.options.areas[this.__activeArea].coords,i=s(e,e[this.__activeCoord],e[this.__activeCoord+1],this.__activeCoord),o=Math.abs(i-this.__activeCoord);!1===i||2!=o&&o!=this.options.areas[this.__activeArea].coords.length-2||(this.options.areas[this.__activeArea].coords.splice(i,2),this.options.onUpdateArea(this.options.areas[this.__activeArea]),this.__redraw()),this.__activeCoord=null},__rightclick:function(e){e.preventDefault(),e.offsetX=e.pageX-t(this.__$canvas[0]).offset().left,e.offsetY=e.pageY-t(this.__$canvas[0]).offset().top;var i=e.offsetX,o=e.offsetY;t.browser.msie&&parseFloat(t.browser.version)<8&&(o=e.offsetY-t("body").scrollTop());var a=s(this.options.areas[this.__activeArea].coords,i,o);return!1!==a&&(this.options.areas[this.__activeArea].coords.splice(a,2),this.options.onUpdateArea(this.options.areas[this.__activeArea]),this.__redraw()),!1},__mousedown:function(i){var o,a,n=this.options.areas[this.__activeArea].coords.length,r=this;if(3===i.which)return!1;i.preventDefault(),i.offsetX=i.pageX-t(this.__$canvas[0]).offset().left,i.offsetY=i.pageY-t(this.__$canvas[0]).offset().top,o=i.offsetX,a=i.offsetY,t.browser.msie&&parseFloat(t.browser.version)<8&&(a=i.offsetY-t("body").scrollTop());var _=s(this.options.areas[this.__activeArea].coords,o,a);if(!1!==_)return this.__activeCoord=_,t(this.element).on("mousemove",function(t){r.__move(t)}),!1;for(var h=0;h<this.options.areas[this.__activeArea].coords.length;h+=2)h>1&&e(o,a,this.options.areas[this.__activeArea].coords[h],this.options.areas[this.__activeArea].coords[h+1],this.options.areas[this.__activeArea].coords[h-2],this.options.areas[this.__activeArea].coords[h-1],!0)<6&&(n=h);return this.options.areas[this.__activeArea].coords.splice(n,0,Math.round(o),Math.round(a)),this.__activeCoord=n,t(this.element).on("mousemove",function(t){r.__move(t)}),this.options.onUpdateArea(this.options.areas[this.__activeArea]),this.__redraw(),!1},__mouseup:function(){this.__stopdrag()},__draw:function(){this.__ctx.canvas.width=this.__ctx.canvas.width,this.__ctx.globalCompositeOperation="source-over";for(var t=0;t<this.options.areas.length;t++)t!=this.__activeArea&&this.__drawArea(t);this.__drawArea(this.__activeArea)},__isArea:function(t){return this.options.areas[t].coords.length>2},__onAreaSelect:function(){"function"==typeof this.options.onSelect&&this.options.onSelect(this.__isArea(this.__activeArea)?this.__activeArea:null)},__drawArea:function(t){var s="",e="",i="",o="",a=function(t){for(var s,e=[],i=(t||"").slice(1).split(""),o=0;o<i.length;o+=2)s=i.slice(o,o+2).join(""),e.push(parseInt(s,16));return e},n=function(t,s){if(t.indexOf(",")>0)e=s?"rgba("+t+","+s+")":"rgb("+t+")";else var e=(s?"rgba(%s,"+s+")":"rgb(%s)").replace("%s",a(t).join(","));return e};if(this.options.areas[t].coords.length<2)return!1;t==this.__activeArea?(s=n(this.options.activeColor),e=n(this.options.activeColor,this.options.fillOpacity),i=s,o=n(this.options.handleColor)):(i=s=n(this.options.inactiveColor),o=e=n(this.options.inactiveColor,this.options.fillOpacity)),this.__ctx.lineWidth=this.options.lineWidth,this.__ctx.beginPath(),this.__ctx.moveTo(this.options.areas[t].coords[0],this.options.areas[t].coords[1]),this.__boundaryArea[0]=this.__boundaryArea[2]=this.options.areas[t].coords[0],this.__boundaryArea[1]=this.__boundaryArea[3]=this.options.areas[t].coords[1];for(_=0;_<this.options.areas[t].coords.length;_+=2)this.options.areas[t].coords.length>2&&_>1&&(this.__ctx.lineTo(this.options.areas[t].coords[_],this.options.areas[t].coords[_+1]),this.__boundaryArea[0]=Math.min(this.__boundaryArea[0],this.options.areas[t].coords[_]),this.__boundaryArea[1]=Math.min(this.__boundaryArea[1],this.options.areas[t].coords[_+1]),this.__boundaryArea[2]=Math.max(this.__boundaryArea[2],this.options.areas[t].coords[_]),this.__boundaryArea[3]=Math.max(this.__boundaryArea[3],this.options.areas[t].coords[_+1]));this.__ctx.closePath(),this.__ctx.strokeStyle=s,this.__ctx.stroke(),this.__ctx.fillStyle=e,this.__ctx.fill();var r=Math.max(3,this.options.lineWidth);this.__ctx.strokeStyle=i,this.__ctx.fillStyle=o;for(var _=0;_<this.options.areas[t].coords.length;_+=2)this.__ctx.strokeRect(this.options.areas[t].coords[_]-r,this.options.areas[t].coords[_+1]-r,2*r,2*r),this.__ctx.fillRect(this.options.areas[t].coords[_]-r,this.options.areas[t].coords[_+1]-r,2*r,2*r);this.__ctx.font=this.options.labelFont,this.__ctx.fillStyle=n(this.options.labelColor),this.__ctx.fillText(this.options.label,this.__boundaryArea[0],this.__boundaryArea[1])},__fixActiveAreaIndex:function(){void 0===this.options.areas[this.__activeArea]&&(void 0!==this.options.areas[this.__activeArea-1]?this.setActiveAreaIndex(this.__activeArea-1):this.setActiveAreaIndex(this.__activeArea))},removeAll:function(){this.options.areas=[],this.__fixActiveAreaIndex(),this.__redraw()},getMode:function(){return this.options.mode},isCSMode:function(){return"continiousSelect"===this.getMode()},getAreas:function(){return this.options.areas},setAreas:function(t){this.options.areas=t,this.setActiveAreaIndex(0),this.__redraw()},getArea:function(t){return this.options.areas[t]},setArea:function(t,s){this.options.areas[t]=s,this.__redraw()},removeArea:function(t){this.options.areas.splice(t,1),this.__fixActiveAreaIndex(),this.__redraw()},resetArea:function(t){this.setArea(t,{href:"",coords:[]}),this.options.onUpdateArea(this.options.areas[t]),this.__redraw()},getActiveArea:function(){return this.options.areas[this.__activeArea]},setActiveArea:function(t){this.setArea(this.__activeArea,t)},resetActiveArea:function(){this.resetArea(this.__activeArea)},removeActiveArea:function(){this.removeArea(this.__activeArea)},getActiveAreaIndex:function(){return this.__activeArea},setActiveAreaIndex:function(t){t<0||(this.__activeArea=t,void 0===this.options.areas[t]&&this.resetArea(t),this.__redraw())},setImageUrl:function(s,e){var i=this,o=function(){"function"==typeof e&&e()};this.options.imageUrl=s;var a=function(){i.options.image?t(i.__$canvas).css({position:"absolute",width:"100%",height:"100%",top:0,left:0}):t(i.__$canvas).css({background:"url("+i.__image.src+")"}),i.__redraw(),o()},n=function(){var t=i.__image;null==t.complete||1!=t.complete?setTimeout(n,500):a()};t(this.__image).load(a),n(),this.__image.src!==s&&(this.__image.src=s)},getImageUrl:function(){return this.options.imageUrl},_CSMode:{context:null,init:function(s){this.context=s,this.__mouseMoves=[],this.__$drawCanvas=this.context._initCanvas(),t(this.context.element).css({position:"relative"}),t(this.context.element).append(this.__$drawCanvas),t(this.context.__$canvas).on("mousemove",this.__mousemove.bind(this)),t(this.__$drawCanvas).on("mousemove",this.__mousemove.bind(this)),t(this.__$drawCanvas).on("mouseup",this.__mouseup.bind(this)),t(this.__$drawCanvas).on("mousedown",this.__mousedown.bind(this)),t(this.__$drawCanvas).on("mouseleave",this.__stopDrag.bind(this)),this.__drawCanvasCtx=this.__$drawCanvas[0].getContext("2d")},_addClick:function(s,e){var i=t(s.target).offset();this.__mouseMoves.push({x:s.pageX-i.left,y:s.pageY-i.top,isDragging:e})},__mousedown:function(t){var s=this.context.getAreas();this.context.setActiveAreaIndex(s.length),t.preventDefault(),this._isDrawing=!0,this._showDrawArea(),this.__mouseMoves=[],this._addClick(t)},__click:function(){for(var t=this.__mouseMoves[0],s=this.context.getAreas().reverse(),e=null,i=0;i<s.length;i++)if(function(t,s){for(var e={left:!1,right:!1,top:!1,bottom:!1},i=0;i<s.length;i+=2)s[i]<t.x?e.left=!0:e.right=!0,s[i+1]<t.y?e.top=!0:e.bottom=!0;return e.left&&e.right&&e.top&&e.bottom}(t,s[i].coords)){e=i;break}"number"==typeof e&&this.context.setActiveAreaIndex(e),this.context.__onAreaSelect()},_prepareCoords:function(t){var s=this.context.options.approximationStep||0;return function(t){var s=[];return t.forEach(function(t){s.push.call(s,t.x,t.y)}),s}(function(t){for(var e=[t[0]],i=function(t,e){return Math.abs(t-e)>s},o=null,a=1;a<t.length;a++)o=e[e.length-1],a<t.length-1&&i(t[a].x,o.x)&&i(t[a].y,o.y)&&e.push(t[a]);return e}(t))},__mouseup:function(t){return t.preventDefault(),"none"!==this.__$drawCanvas.css("display")&&(this.__stopDrag(),this._showDrawArea(!1),this._clearCtx(),1===this.__mouseMoves.length?this.__click():!(this.__mouseMoves.length<3)&&void this.context.setActiveArea({coords:this._prepareCoords(this.__mouseMoves)}))},__mousemove:function(t){if(!this._isDrawing)return!1;this._addClick(t,!0),this._redraw()},_clearCtx:function(){this.context._clearCtx(this.__drawCanvasCtx)},_redraw:function(){var t=this.__drawCanvasCtx;this._clearCtx(),t.strokeStyle="#df4b26",t.lineJoin="round",t.lineWidth=5;for(var s=0;s<this.__mouseMoves.length;s++)t.beginPath(),this.__mouseMoves[s].isDragging&&s?t.moveTo(this.__mouseMoves[s-1].x,this.__mouseMoves[s-1].y):t.moveTo(this.__mouseMoves[s].x-1,this.__mouseMoves[s].y),t.lineTo(this.__mouseMoves[s].x,this.__mouseMoves[s].y),t.stroke(),t.closePath()},onCanvasSizeUpdate:function(){var t=this.context.__$canvas,s=t.width(),e=t.height();this.__$drawCanvas.attr("height",e).attr("width",s),this.__$drawCanvas.css({display:"none",position:"absolute",left:0,top:0,width:s+"px",height:e+"px"}),this.__$drawCanvas.width=s,this.__$drawCanvas.height=e},__stopDrag:function(){this._isDrawing=!1},_showDrawArea:function(t){!1!==t?this.__$drawCanvas.css({display:"inline-block"}):this.__$drawCanvas.hide()}}});var s=function(t,s,e,i){for(var o=0;o<t.length;o+=2)if(dis=Math.sqrt(Math.pow(s-t[o],2)+Math.pow(e-t[o+1],2)),dis<10&&o!==i)return o;return!1},e=function(t,s,e,i,o,a,n){function r(t,s,e,i){return Math.sqrt((t-=e)*t+(s-=i)*s)}if(!n||(n=function(t,s,e,i,o,a){if(!(o-e))return{x:e,y:s};if(!(a-i))return{x:t,y:i};var n,r=-1/((a-i)/(o-e));return{x:n=(o*(t*r-s+i)+e*(t*-r+s-a))/(r*(o-e)+i-a),y:r*n-r*t+s}}(t,s,e,i,o,a)).x>=Math.min(e,o)&&n.x<=Math.max(e,o)&&n.y>=Math.min(i,a)&&n.y<=Math.max(i,a)){var _=i-a,h=o-e,c=e*a-i*o;return Math.abs(_*t+h*s+c)/Math.sqrt(_*_+h*h)}var d=r(t,s,e,i),v=r(t,s,o,a);return d>v?v:d},i=function(t){a(t)},o=function(t){t||(t=document),t.addEventListener("touchstart",i,!0),t.addEventListener("touchmove",i,!0),t.addEventListener("touchend",i,!0)},a=function(t,s){t.preventDefault();var e=t.changedTouches[0]||t,i=document.createEvent("MouseEvent");i.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[t.type],!0,!0,window,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),i.originalType=t.type,(s||e.target).dispatchEvent(i)}}(jQuery);